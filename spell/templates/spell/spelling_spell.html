{% extends "spell/layout.html" %}

{% block title %}SpellNOW!&trade; -- Spelling Activity{% endblock %}

{% block function %}
  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Spelling Activity</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item">Activities</li>
          <li class="breadcrumb-item active">Spelling</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    
    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Spelling</h5>
              <p>Spell the words you hear and type your answer in the box below.
                Add tags to words after you have spelled them for review.</p>
              <div id="nothing">
                <button onclick="neword()" style="display: block;" class="btn btn-primary" type="button">Click to Launch Activity</button>
              </div>
              
              <div id="everything" style="display:none;">
                <p style="color: #4d4d4d;" id="progress"></p>
                <p style="color: #2dab26;" id="correct"></p>
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="spelling" spellcheck="false" autocomplete="off" name="tag" placeholder="Spelling...">
                      <label for="spelling">Spelling</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <button type="button" class="btn btn-primary" id="check" onclick="spell()">CHECK</button>
                  </div>
                </div>
                <p><b style="display: none;" id="response"></b></p>
                <button onclick="repron()" type="button" class="btn btn-secondary">Pronounce</button>
                <button onclick="spec()" type="button" class="btn btn-secondary">Part of Speech</button>
                <button onclick="origin()" type="button" class="btn btn-secondary">Language of Origin</button>
                <button onclick="def()" type="button" class="btn btn-secondary">Definition</button>
                <br><br>
                <div id="tags" style="display: none;">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="tag_value" spellcheck="false" autocomplete="off" name="tag" placeholder="New Tag...">
                        <label for="spelling">New Tag</label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <button onclick="new_tag()" type="button" class="btn btn-primary" value="Create">Create</button>
                    </div>
                  </div>
                  <p><b style="display: none;" style="color:red" id="id_response">Invalid Tag Name: The tag contains three dashes (---), a quotation mark ("), a apostrophe ('), a star followed by two dots followed by a star (*..*), or a comma followed by a space (, ).</b></p>
                  <div id="alltags">
                      {% for tag in tags %}
                          <button style="color:rgb(13, 110, 253); background-color: rgb(255, 255, 255);" onclick="add_word('{{ tag.name }}')" id="{{ tag.name }}" type="button" class="btn btn-primary rounded-pill tag">{{ tag.name }}</button>
                      {% endfor %}
                  </div>
                </div>
                <br><br>
                <p style="display:none;" id="speech"></p>
                <p><b>Language of Origin:</b></p>
                <div style="display:none;" id="origin">
                </div>
                <br>
                <p><b>Definition:</b></p>
                <div style="display:none;" id="def">
                </div>
                <br>
              </div>
            </div>
          </div>
        </div>
      </div>
      <form style="display: none;" enctype="multipart/form-data" action="{% url 'finish' %}" method="post">
        {% csrf_token %}
        <textarea name="words" id="words"></textarea>
        <textarea name="new_tags" id="new_tags"></textarea>
        <textarea name="add_words" id="add_words"></textarea>
        <textarea name="tags_used" id="tags_used">{{ tags_used }}</textarea>
        <textarea name="order" id="order">{{ order }}</textarea>
        <textarea name="correct_array" id="correct_array"></textarea>
        <textarea name="attempts" id="attempts"></textarea>
        <textarea name="time" id="time"></textarea>
        <input name="score" id="score">
        <input id="stop" type="submit">
    </form>
    </section>
  </main><!-- End #main -->
  <script>
    var g_words = "{{ words|safe }}";
    g_words = g_words.replaceAll("'", '"');
    var g_speech = "{{ speech|safe }}";
    g_speech = g_speech.replaceAll("'", '"');
    var g_origin = "{{ origin }}";
    var g_definition = "{{ definition }}";
    var g_prons = "{{ prons|safe }}";
    var correct_array = "";
    var total_tags = "{{ final_tags }}"
    const lalith = total_tags.split('&gt;&lt;');
    const words = JSON.parse(g_words);
    const speech = JSON.parse(g_speech);
    const origins = g_origin.split("|=[]=|");
    origins.pop();
    const definition = g_definition.split("|=[]=|");
    definition.pop();
    const prons = g_prons.split(' || ');
    
    var global_count = 0;
    var correct = 0;
    var progress = 0;
    var word_count = words.length;
    var pron_link = "";
    var watch = 0;
    var stopwatch;
    stopwatch = setInterval(function () {if (document.getElementById("nothing").style.display == "none") {watch++;}}, 1000);
    
    function neword() {
        document.getElementById("nothing").style.display = "none";
        document.getElementById("everything").style.display = "block";
        if (speech.length != 0) {
            document.getElementById("speech").innerHTML = ("<b>Part of Speech: </b>" + speech[global_count])
        }
        if (origins.length != 0) {
            var funny = origins[global_count].split("--++--");
            document.getElementById("origin").innerHTML = "<ol>"
            for (var i = 0; i < 3; i++) {
                if (funny[i] != "-||-") {
                    document.getElementById("origin").innerHTML += ("<li>" + funny[i] + "</li>");
                }
                document.getElementById("origin").innerHTML += "</ol>"
            }
        }
        if (definition.length != 0) {
            var funny = definition[global_count].split("--++--");
            document.getElementById("def").innerHTML = "<ol>"
            for (var i = 0; i < 3; i++) {
                if (funny[i] != "-||-") {
                    document.getElementById("def").innerHTML += ("<li>" + funny[i] + "</li>");
                }
                document.getElementById("def").innerHTML += "</ol>"
            }
        }
        var prons_test = prons[global_count];
        prons_test = prons_test.replaceAll("'", '"');

        if (prons_test.includes("*--*")) {
            var snd = new Audio("/static/spell/sounds/" + words[global_count] + ".mp3");
            snd.play();
        }
        else {
            obj = JSON.parse(prons_test)
            for (var i = 0; i < obj.length; i++) {
                pron_link = obj[i];
                const myTimeout = setTimeout(pronounce, 1000);
            }
        }
    }

    function pronounce() {
        var snd = new Audio(pron_link);
        snd.play();
    }

    function repron() {
        var prons_test = prons[global_count];
        prons_test = prons_test.replaceAll("'", '"');

        if (prons_test.includes("*--*")) {
            var snd = new Audio("/static/spell/sounds/" + words[global_count] + ".mp3");
            snd.play();
        }
        else {
            obj = JSON.parse(prons_test)
            for (var i = 0; i < obj.length; i++) {
                pron_link = obj[i];
                const myTimeout = setTimeout(pronounce, 1000);
            }
        }
    }

    function spell() {
        if (document.getElementById("check").innerHTML == "CHECK") {
            if (document.getElementById("spelling").value == "") {
                document.getElementById("response").style.display = "block";
                document.getElementById("response").style.color = "#b5ae00";
                document.getElementById("response").innerHTML = "WARNING: Please input a valid spelling into the input area.";
            }
            else if (document.getElementById("spelling").value.toLowerCase() != words[global_count]) {
                document.getElementById("response").style.display = "block";
                document.getElementById("response").style.color = "red";
                document.getElementById("response").innerHTML = "INCORRECT: The correct spelling is '" + words[global_count] + "'.";
                document.getElementById("tags").style.display = "block";
                document.getElementById("check").innerHTML = "NEXT";
                if (global_count + 1 == word_count) {
                    document.getElementById("check").innerHTML = "FINISH";
                }
                progress += 1;
                correct_array += "0, ";
                document.getElementById("progress").innerHTML = ("<b>Progress: </b>" + progress + "/" + word_count);
                document.getElementById("correct").innerHTML = ("<b>Correct: </b>" + correct + "/" + progress);
                document.getElementById("attempts").innerHTML += (document.getElementById("spelling").value.toLowerCase() + ", ");
                
                const tester = lalith[global_count].split("&lt;&gt;");
                for (let i = 0; i < tester.length; i++) {
                    document.getElementById(tester[i]).style.color = "rgb(255, 255, 255)";
                    document.getElementById(tester[i]).style.backgroundColor = "rgb(13, 110, 253)";
                }
            }
            else {
                document.getElementById("response").style.display = "block";
                document.getElementById("response").style.color = "green";
                document.getElementById("response").innerHTML = "CORRECT!";
                document.getElementById("tags").style.display = "block";
                document.getElementById("check").innerHTML = "NEXT";
                if (global_count + 1 == word_count) {
                    document.getElementById("check").innerHTML = "FINISH";
                }
                correct_array += "1, ";
                correct += 1;
                progress += 1;
                document.getElementById("progress").innerHTML = ("<b>Progress: </b>" + progress + "/" + word_count);
                document.getElementById("correct").innerHTML = ("<b>Correct: </b>" + correct + "/" + progress);
                document.getElementById("attempts").innerHTML += (document.getElementById("spelling").value.toLowerCase() + ", ");

                const tester = lalith[global_count].split("&lt;&gt;");
                for (let i = 0; i < tester.length; i++) {
                    document.getElementById(tester[i]).style.color = "rgb(255, 255, 255)";
                    document.getElementById(tester[i]).style.backgroundColor = "rgb(13, 110, 253)";
                }
            }
        }
        else if (document.getElementById("check").innerHTML == "NEXT") {
            document.getElementById("response").style.display = "none";
            document.getElementById("tags").style.display = "none";
            document.getElementById("speech").style.display = "none";
            document.getElementById("origin").style.display = "none";
            document.getElementById("def").style.display = "none";
            document.getElementById("spelling").value = "";
            document.getElementById("check").innerHTML = "CHECK"
            const nodeList = document.querySelectorAll(".tag");
            for (let i = 0; i < nodeList.length; i++) {
                nodeList[i].style.color = "rgb(13, 110, 253)";
                nodeList[i].style.backgroundColor = "rgb(255, 255, 255)";
            }
            global_count += 1;
            
            document.getElementById("time").innerHTML += (watch + ", ");
            watch = 0;

            neword();
        }
        else {
            document.getElementById("time").innerHTML += (watch + ", ");

            document.getElementById("correct_array").innerHTML = correct_array;
            document.getElementById("score").value = (correct + "/" + word_count);
            document.getElementById('stop').click();
        }
    }

    function add_word(tag) {
        if (document.getElementById(tag).style.color == "rgb(13, 110, 253)" || document.getElementById(tag).style.color == "") {
            document.getElementById(tag).style.color = "rgb(255, 255, 255)";
            document.getElementById(tag).style.backgroundColor = "rgb(13, 110, 253)";
            var thing = "---" + tag + "||" + words[global_count] + "[]";
            document.getElementById("add_words").innerHTML = (document.getElementById("add_words").innerHTML).replace(thing, '');
            const tester = lalith[global_count].split("&lt;&gt;");
            if (!tester.includes(tag)) {
                document.getElementById("add_words").innerHTML += tag + "||" + words[global_count] + "[]";
            }
        }
        else {
            document.getElementById(tag).style.color = "rgb(13, 110, 253)";
            document.getElementById(tag).style.backgroundColor = "rgb(255, 255, 255)";
            var thing = tag + "||" + words[global_count] + "[]";
            document.getElementById("add_words").innerHTML = (document.getElementById("add_words").innerHTML).replace(thing, '');
            const tester = lalith[global_count].split("&lt;&gt;");
            if (tester.includes(tag)) {
                document.getElementById("add_words").innerHTML += ("---" + tag + "||" + words[global_count] + "[]");
            }
        }
    }

    function new_tag() {
        name = document.getElementById("tag_value").value;
        if (!((name.includes("---")) || (name.includes('"')) || (name.includes("'")) || (name.includes("*..*")) || (name.includes(", ")) || (name == ""))) {
            document.getElementById("tag_value").value = "";
            other_name = "add_word('" + name + "')";
            document.getElementById("alltags").innerHTML += '<button style="color:rgb(13, 110, 253); background-color: rgb(255, 255, 255);" onclick="' + other_name + '" id="' + name + '" type="button" class="btn btn-primary rounded-pill tag">' + name + '</button>'
            document.getElementById("new_tags").innerHTML += (name + "[]")
            document.getElementById("id_response").style.display = "none";
        }
        else {
            document.getElementById("id_response").style.display = "block";
        }
    }

    document.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            if (document.activeElement.id == "spelling") {
                spell();
            }
            else {
                new_tag();
            }
        }
    });

    function spec() {
        document.getElementById("speech").style.display = "block";
    }

    function origin() {
        document.getElementById("origin").style.display = "block";
    }

    function def() {
        document.getElementById("def").style.display = "block";
    }


    var usings = (document.getElementById("tags_used").innerHTML).split(", ");
    var orders = (document.getElementById("order").innerHTML).split(", ");

    for (user of usings) {
        if (!(orders.includes(user))) {
            if (document.getElementById("not_included").innerHTML == "") {
                document.getElementById("not_included").innerHTML += ("Due to word overlap, the following tags are not included: " + user + ", ");
            }
            else {
                document.getElementById("not_included").innerHTML += (user + ", ");
            }
        }
    }
    var arrayLength = words.length;
    for (var i = 0; i < arrayLength; i++) {
        document.getElementById("words").innerHTML += (words[i] + ", ");
    }
    document.getElementById("progress").innerHTML = ("<b>Progress: </b>0/" + word_count);
    document.getElementById("correct").innerHTML = ("<b>Correct: </b>0/0");

</script>
{% endblock %}